
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';

type Occasion = 'ä»•äº‹' | 'ã‚¢ãƒ•ã‚¿ãƒ¼6' | 'ãƒ‡ãƒ¼ãƒˆ' | 'ä¼‘æ—¥ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«' | 'ãã‚Œã„ã‚ã‚¤ãƒ™ãƒ³ãƒˆ';
type Style = 'ãã‚Œã„ã‚' | 'ãã‚Œã„ã‚ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«' | 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«' | 'ãƒ¢ãƒ¼ãƒ‰';

// å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å‹å®šç¾©
type WeatherData = {
  city: string;
  tempNow: number;
  condition: string;
  hi: number;
  lo: number;
  feelsLike: number;
  humidity: number | null;
  windKmh: number;
};

const OCCASIONS: { key: Occasion; icon: string }[] = [
  { key: 'ä»•äº‹', icon: 'ğŸ’¼' },
  { key: 'ã‚¢ãƒ•ã‚¿ãƒ¼6', icon: 'ğŸŒ™' },
  { key: 'ãƒ‡ãƒ¼ãƒˆ', icon: 'â¤ï¸' },
  { key: 'ä¼‘æ—¥ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«', icon: 'â˜€ï¸' },
  { key: 'ãã‚Œã„ã‚ã‚¤ãƒ™ãƒ³ãƒˆ', icon: 'âœ¨' },
];

const STYLES: { key: Style }[] = [
  { key: 'ãã‚Œã„ã‚' },
  { key: 'ãã‚Œã„ã‚ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«' },
  { key: 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«' },
  { key: 'ãƒ¢ãƒ¼ãƒ‰' },
];

function cn(...classes: Array<string | false | undefined>) {
  return classes.filter(Boolean).join(' ');
}

function Chip(props: {
  label: string;
  icon?: string;
  selected?: boolean;
  onClick?: () => void;
}) {
  const { label, icon, selected, onClick } = props;
  return (
    <button
      type="button"
      onClick={onClick}
      className={cn(
        'inline-flex items-center justify-center gap-2 rounded-full border px-4 py-3 text-sm font-medium transition',
        'active:scale-[0.99]',
        selected
          ? 'border-transparent bg-[#D4A574] text-white'
          : 'border-[#E8DED3] bg-white text-[#3D3D3D]'
      )}
      aria-pressed={selected}
    >
      {icon ? <span className="text-base leading-none">{icon}</span> : null}
      <span>{label}</span>
    </button>
  );
}

function Card(props: { children: React.ReactNode }) {
  return (
    <div className="rounded-2xl bg-[#FFF5EB] p-5 shadow-sm ring-1 ring-[#E8DED3]">
      {props.children}
    </div>
  );
}

export default function Home() {
  const [occasion, setOccasion] = useState<Occasion>('ãƒ‡ãƒ¼ãƒˆ');
  const [style, setStyle] = useState<Style>('ãã‚Œã„ã‚ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«');
  
  // ãƒšãƒ¼ã‚¸é·ç§»ç”¨ã®ãƒ«ãƒ¼ã‚¿ãƒ¼
  const router = useRouter();
  
  // å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ…‹ç®¡ç†
  const [weather, setWeather] = useState<WeatherData | null>(null);
  // å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã®çŠ¶æ…‹ç®¡ç†
  const [isLoading, setIsLoading] = useState(false);

  // å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
  const fetchWeather = async () => {
    setIsLoading(true);
    try {
      const response = await fetch('/api/weather');
      if (!response.ok) {
        throw new Error('å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      const data = await response.json();
      setWeather(data);
    } catch (error) {
      console.error('å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã¯å‹•ä½œã—ç¶šã‘ã‚‹
    } finally {
      setIsLoading(false);
    }
  };

  // åˆå›è¡¨ç¤ºæ™‚ã«å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  useEffect(() => {
    fetchWeather();
  }, []);

  return (
    <div className="min-h-dvh bg-[#FFFAF5] text-[#3D3D3D]">
      <div className="mx-auto w-full max-w-[420px] px-5 pb-10 pt-10">
        {/* Header */}
        <header className="text-center">
          <h1 className="text-3xl font-extrabold tracking-tight">ä»Šæ—¥ã®ã‚³ãƒ¼ãƒ‡</h1>
          <p className="mt-2 text-sm text-[#7A7A7A]">ã‚ãªãŸã«ã´ã£ãŸã‚Šã®ã‚³ãƒ¼ãƒ‡ã‚’ææ¡ˆ</p>
        </header>

        {/* Weather */}
        <section className="mt-8">
          <Card>
            <div className="flex items-start justify-between">
              <div className="text-sm font-semibold text-[#7A7A7A]">
                {weather?.city || 'æ±äº¬ã®å¤©æ°—'}
              </div>
              <button
                type="button"
                className="text-xs font-medium text-[#7A7A7A] hover:opacity-80"
                onClick={fetchWeather}
                disabled={isLoading}
              >
                {isLoading ? 'æ›´æ–°ä¸­â€¦' : 'æ›´æ–°'}
              </button>
            </div>

            <div className="mt-4 flex items-center gap-4">
              <div className="text-4xl">ğŸŒ¤ï¸</div>
              <div className="flex-1">
                <div className="text-5xl font-extrabold leading-none">
                  {weather?.tempNow ?? '--'}Â°
                </div>
                <div className="mt-2 text-sm font-semibold">
                  {weather?.condition || 'å–å¾—ä¸­...'}
                </div>
              </div>

              <div className="text-right">
                <div className="text-lg font-bold text-[#C66A6A]">
                  {weather?.hi ?? '--'}Â°
                </div>
                <div className="text-lg font-bold text-[#7A7A7A]">
                  / {weather?.lo ?? '--'}Â°
                </div>
                <div className="mt-2 text-xs text-[#7A7A7A]">
                  ä½“æ„Ÿ {weather?.feelsLike ?? '--'}Â°
                </div>
              </div>
            </div>

            <div className="mt-5 h-px w-full bg-[#E8DED3]" />

            <div className="mt-4 grid grid-cols-2 gap-6 text-sm">
              <div>
                <div className="text-xs font-semibold text-[#7A7A7A]">æ¹¿åº¦</div>
                <div className="mt-1 text-lg font-bold">
                  {weather?.humidity !== null && weather?.humidity !== undefined
                    ? `${weather.humidity}%`
                    : '--%'}
                </div>
              </div>
              <div className="text-right">
                <div className="text-xs font-semibold text-[#7A7A7A]">é¢¨é€Ÿ</div>
                <div className="mt-1 text-lg font-bold">
                  {weather?.windKmh ?? '--'}km/h
                </div>
              </div>
            </div>
          </Card>
        </section>

        {/* Occasion */}
        <section className="mt-10">
          <h2 className="text-xl font-extrabold">ä»Šæ—¥ã®äºˆå®šã¯ï¼Ÿ</h2>

          <div className="mt-4 grid grid-cols-2 gap-3">
            {OCCASIONS.map((o) => (
              <Chip
                key={o.key}
                label={o.key}
                icon={o.icon}
                selected={occasion === o.key}
                onClick={() => setOccasion(o.key)}
              />
            ))}
          </div>
        </section>

        {/* Style */}
        <section className="mt-10">
          <h2 className="text-xl font-extrabold">å¥½ããªæœè£…ã®ã‚¸ãƒ£ãƒ³ãƒ«ã¯ï¼Ÿ</h2>

          <div className="mt-4 grid grid-cols-2 gap-3">
            {STYLES.map((s) => (
              <Chip
                key={s.key}
                label={s.key}
                selected={style === s.key}
                onClick={() => setStyle(s.key)}
              />
            ))}
          </div>
        </section>

        {/* CTA */}
        <section className="mt-10">
          <button
            type="button"
            className="w-full rounded-2xl bg-[#D4A574] py-5 text-lg font-extrabold text-white shadow-md active:scale-[0.99]"
            onClick={() => {
              // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
              const queryParams: string[] = [];
              
              // ç¾åœ¨ã®æ°—æ¸©ï¼ˆweatherãŒnullã®å ´åˆã¯è¿½åŠ ã—ãªã„ï¼‰
              if (weather?.tempNow !== undefined && weather.tempNow !== null) {
                queryParams.push(`temp=${weather.tempNow}`);
              }
              
              // ä½“æ„Ÿæ¸©åº¦ï¼ˆweatherãŒnullã®å ´åˆã¯è¿½åŠ ã—ãªã„ï¼‰
              if (weather?.feelsLike !== undefined && weather.feelsLike !== null) {
                queryParams.push(`feels=${weather.feelsLike}`);
              }
              
              // ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ—¥æœ¬èªãªã®ã§encodeURIComponentã‚’ä½¿ç”¨ï¼‰
              queryParams.push(`occasion=${encodeURIComponent(occasion)}`);
              
              // ãƒ†ã‚¤ã‚¹ãƒˆï¼ˆæ—¥æœ¬èªãªã®ã§encodeURIComponentã‚’ä½¿ç”¨ï¼‰
              queryParams.push(`style=${encodeURIComponent(style)}`);
              
              // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã§çµæœç”»é¢ã«é·ç§»
              const queryString = queryParams.join('&');
              router.push(`/result?${queryString}`);
            }}
          >
            ã‚³ãƒ¼ãƒ‡ã‚’ææ¡ˆã™ã‚‹
          </button>
        </section>

        {/* Footer Nav (ãƒ€ãƒŸãƒ¼) */}
        <footer className="mt-10 flex justify-center">
          <div className="flex flex-col items-center gap-1 text-xs font-semibold text-[#D4A574]">
            <div className="text-xl">ğŸ </div>
            <div>Home</div>
          </div>
        </footer>
      </div>
    </div>
  );
}
